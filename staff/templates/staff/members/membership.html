{% extends "staff/members/base.html" %}

{% block sub-title %}Edit Membership | {% endblock %}


{% block content %}
<h4 id='membership-h4'>Membership for <a href="{% url 'staff:members:detail' entity.username %}">{{ entity.get_full_name }}</a></h4>

<div id='promptModal' class='modal'>
  <div class='modal-content'>
    <div class='modal-body'>
      <h5>What do you want to do?</h5>
      <div class='sub-chips'>
        <a id='change' class='chip'>New Package</a>
        | <a id='update' class='chip'>Update Current Subscriptions</a>
        | <a id='end' class='chip'>End Current Package</a>
      </div>
    </div>
  </div>
</div>
<div class='select-date'>
  <table class='date-table'>
    <tr>
      <th>
        <strong>Effective Date?</strong>
      </th>
      <td id='select-end-td'>
        <select id='target-input'>
          <option disabled>
            Select One
          </option>
          <option value='yesterday'>
            Yesterday
          </option>
          <option selected value='today'>
            Today
          </option>
          <option class='change-eop' value='eop'>
          </option>
          <option value='other'>
            Other
          </option>
        </select>
      </td>
      <td style='width:30%;'>
        <input id='sub-end' name='date-end' class='datepicker' placeholder="Select Date" />
      </td>
    </tr>
  </table>
</div>
<div class='select-pkg'>
  <form class='change-form' action='.' method='GET'>
    <table>
      <tr>
        <th>
          <strong>Select a New Package: </strong>
        </th>
        <td id='new-package'>
          {{ package_form.package }}
        </td>
        <td style='width:30%;'></td>
      </tr>
    </table>
    <input type='hidden' name='target_date' id='target_date' />
  </form>
</div>
<div class='curr-sub'>
  <h6>Current Subscriptions</h6>
  <table class='sub-table' style='margin-top: 2%;'>
    <tr>
      <th class='sub-th'>Resource</th>
      <th class='sub-th'>Allowance</th>
      <th class='sub-th'>Start Date</th>
      <th class='sub-th'>End Date</th>
      <th class='sub-th'>Overage</th>
      <th class='sub-th'>Monthly</th>
      <th class='sub-th'>Paid By</th>
    </tr>
    {% for s in entity.membership.active_subscriptions %}
      <tr class='{% cycle "row-even" "row-odd" %}'>
        <td>{{ s.resource }}</td>
        <td>{{ s.allowance }}</td>
        <td>{{ s.start_date }}</td>
        {% if s.end_date %}
          <td>{{ s.end_date }}</td>
        {% else %}
          <td>-</td>
        {% endif %}
        <td>${{ s.overage_rate }}</td>
        <td>${{ s.monthly_rate }}/month</td>
        <td>{{ s.paid_by|default:"" }}</td>
      </tr>
    {% endfor %}
    <tr>
      <td colspan="5"><strong>Total:</strong></td>
      <td><strong>${{ entity.membership.monthly_rate }}/month</strong><td>
    </tr>
  </table>
</div>

<!-- <div class='curr-sub'>
  <h6 class='mem-details-table'>Current Package Details</h6>
  <table class='mem-details-table'>
    <tr>
      <th class='sub-th'>Billing Day</th>
      <th class='sub-th'>Next Bill</th>
      <th class='sub-th'>Package</th>
      <th class='sub-th' style='text-align: center !important;'>What do you want to do?</th>
    </tr>
    <tr>
      <td>{{ entity.membership.bill_day_str }}</td>
      <td>{{ entity.membership.next_period_start }}</td>
      <form>
        <td id='package'>
          {{ entity.membership.package }}
        </td>
        <td class='sub-chips'>
          <a id='change' class='chip'>New Package</a>
          | <a id='update' class='chip'>Update Current Subscriptions</a>
          | <a id='end' class='chip'>End Current Package</a>
        </td>
      </form>
    </tr>
  </table>
</div> -->

<!-- <div id='end-package'>
  <h6>End All Current Subscriptions</h6>
  <form method='POST' action='.' class='end-sub-form'>
    <table>
      <tr>
        <td id='end-header'>
          <strong>When do you want to end?</strong>
        </td>
        <td id='select-end-td'>
          <select name='ending' id='select-end'>
            <option value='today'>
              Today
            </option>
            <option value='yesterday'>
              Yesterday
            </option>
            <option class='end-eop' value='eop'>
              End of This Bill Period
            </option>
            <option value='other'>
              Other
            </option>
          </select>
        </td>
        <td style='width:30%;'>
          <input id='date-end' name='date-end' class='datepicker' placeholder="Select Date" />
        </td>
      </tr>
    </table>
    {% csrf_token %}
    <button class='btn' type='submit' style='display:inline-block; margin-right: 5%; margin-left:40%; margin-top: 2%;'>End All</button><span class='cancel' style='margin-top:2%;'>Cancel</span>
  </form>
</div> -->
  <!-- <h6>Change Membership Package</h6>
    <table class='end-table'>
      <tr>
        <td id='end-header'>
          <strong>When do you want the changes to go in effect?</strong>
        </td>
        <td id='select-end-td'>
          <select name='ending' id='target-input'>
            <option disabled selected="true">
              Select One
            </option>
            <option value='today'>
              Today
            </option>
            <option value='yesterday'>
              Yesterday
            </option>
            <option class='change-eop' value='eop'>
            </option>
            <option value='other'>
              Other
            </option>
          </select>
        </td>
        <td style='width:30%;'>
          <input id='sub-end' name='date-end' class='datepicker' placeholder="Select Date" />
        </td>
      </tr>
    </table>
    <form class='change-form' action='.' method='GET'>
      <table class='sub-table'>
        <tr>
          <td id='end-header'>
            <strong>Choose a New Package: </strong>
          </td>
          <td id='new-package'>
            {{ package_form.package }}
          </td>
            {{ package_form.bill_day }}
            {{ package_form.username }}
          <td style='width:30%; vertical-align: middle;'></td>
        </tr>
      </table>
      <button style='margin-left:45%; margin-top: 2%;' class='btn' type='submit'>Start</button>
      <span display='inline-block' class='cancel'>Cancel</span>
      <input type='hidden' name='target_date' id='target_date' />
    </form> -->
<div id='change-package'>
  <form class='sub-form' action='.' method='POST'>
    <table class='sub-table change-table'>
      {% if subscriptions %}
      <tr>
        <th class='sub-th'>Resource</th>
        <th class='allowance sub-th'>Allowance</th>
        <th class='sub-th'>Start Date</th>
        <th class='sub-th'>End Date</th>
        <th class='rate sub-th'>Monthly Rate</th>
        <th class='rate sub-th'>Overage Rate</th>
        <th class='sub-th'>Paid By</th>
        <th class='sub-th'></th>
      </tr>
      {{ sub_formset.management_form }}
      {% for sub_form in sub_formset %}
      <tr class='sub-formset subs'>
        {{ sub_form.s_id }}
        {% if sub_form.s_id.value %}
          <td class='sub-input disabled'>{{ sub_form.resource }}</td>
          <td class='sub-input allowance disabled'>{{ sub_form.allowance  }}</td>
          <td class='sub-input disabled' id='start_date_td'>{{ sub_form.start_date }}</td>
          <td class='sub-input disabled' id='end_date_td'>{{ sub_form.end_date  }}</td>
          <td class='sub-input rate monthly_rate disabled'>{{ sub_form.monthly_rate  }}</td>
          <td class='sub-input rate disabled'>{{ sub_form.overage_rate }}</td>
          <td class='sub-input disabled'>{{ sub_form.paid_by  }}</td>
        {% else %}
          <td class='sub-input'>{{ sub_form.resource }}</td>
          <td class='sub-input allowance'>{{ sub_form.allowance  }}</td>
          <td class='sub-input' id='start_date_td'>{{ sub_form.start_date  }}</td>
          <td class='sub-input' id='end_date_td'>{{ sub_form.end_date  }}</td>
          <td class='sub-input rate monthly_rate'>{{ sub_form.monthly_rate  }}</td>
          <td class='sub-input rate'>{{ sub_form.overage_rate }}</td>
          <td class='sub-input'>{{ sub_form.paid_by  }}</td>
        {% endif %}
        <td class='sub-input'>
          {% if sub_form.end_date.value %}
          {% elif sub_form.s_id.value  %}
            <a class='delete-row'>End</a>
          {% else %}
          {% endif %}
          <input type='hidden' class='chosen_package' name='package' value="{{ package }}" />
          <input type='hidden' class='ur_bill_day' name='bill_day' value="{{ bill_day }}" />
          {% if entity.username %}
            <input type='hidden' class='thr_username' name='username' value="{{ entity.username }}" />
            {{ sub_form.username}}
          {% else %}
            <input type='hidden' name='org' value='{{ org }}' />
            {{ sub_form.org }}
          {% endif %}
          {{ sub_form.created_by}}
        </td>
			</tr>
      {% endfor %}
    </table>
    {% endif %}
    {% csrf_token %}
    <button class='btn' type='submit' style='display:inline-block; margin-right: 5%; margin-left:40%;'>Update</button><span class='cancel'>Cancel</span>
  </form>
</div>
{% endblock %}

{% block extrajs %}
<script>
  function formatDate(d) {
    var month = '' + (d.getMonth() + 1);
    var day = '' + d.getDate();
    var year = d.getFullYear();

    if (month.length < 2) {
      month = '0' + month;
    }
    if (day.length < 2) {
      day = '0' + day;
    }

    return [year, month, day].join('-');
  }

  function getToday() {
    var date = new Date();
    var today = formatDate(date);
    return today;
  }

  function getYesterday() {
    var date = new Date();
    date.setDate(date.getDate() - 1);
    var yesterday = formatDate(date);
    return yesterday;
  }

  function getEop() {
    var d = new Date();
    var bd = '{{ bill_day }}';
    if (d.getDate() < bd) {
      var month = (d.getMonth() + 1);
      var bd_month = month;
      var day = (bd - 1);
    } else {
      var month = (d.getMonth() + 2);
      var bd_month = month;
      var day = (bd - 1);
    }
    var year = d.getFullYear();

    //if January, increase year by one
    if ( month === 1) {
      year = year + 1;
    }

    //if date is 0, then change to correct date by checking the month
    if (day === 0) {
      if (month === 3) {
        month ='0' + 2;
        day = 28;
      } else if (month === 1){
        month = 12;
        day = 31;
      } else if (month === 5 || month === 7 || month === 10 || month === 12) {
        var sm = [5, 7, 10, 12];
        sm.forEach(function(i) {
          if (i == month) {
            month = i - 1;
            day = 30;
          }
        })
      } else {
        month = month - 1;
        day = 31;
      }
    }

    //make sure formatting is correct
    if (month < 10) {
      month = '0' + month;
    }
    if (day < 10) {
      day = '0' + day;
    }
    if(bd_month < 10) {
      bd_month = '0' + bd_month;
    }
    if(bd < 10) {
      bd = '0' + bd;
    }

    var eopDate = [year, month, day].join('-');
    var bdDate = [year, bd_month, bd].join('-');

    return [eopDate, bdDate];
  }

  function dateFiller(date) {
    $('#change-package').show();
    $('.curr-sub').hide();
    $('#start_date_td input').each(function() {
      if(!($(this).attr('readonly'))) {
        $(this).val(date);
        $(this).attr('readonly', 'readonly');
        $(this).datepicker('destroy');
      }
    })
  }

  function endPackage(period) {
    $('.subs').before("<input type='hidden' name='ending' value=" + period + " />");
    $('.sub-form').submit();
  }

  (function() {
    var availableUsers = [
			{% for u in active_members %}
				 "{{ u.username }}",
			{% endfor %}
		];

    $(".paying_user").autocomplete({
			source: availableUsers
		});

    {% for message in messages %}
      {% if message.tags == 'error' %}
        Materialize.toast('{{ message }}', 60000, 'error-msg msg');
      {% else %}
        Materialize.toast('{{ message }}', 3000, '{{ message.tags }}-msg msg');
      {% endif %}
    {% endfor %}

    $(document).on('click', '#toast-container .toast', function() {
      $(this).fadeOut(function(){
        $(this).remove();
      });
    });
  })();

  $(document).ready(function() {
    $('.button-collapse').sideNav();
    $('.collapsible').collapsible();
    var package = '{{ package }}';
    var targetDate = '{{ target_date }}';
    var start = '';
    var end = '';
    var action = '';

    $('#change-package').hide();
    $('#sub-end').hide();

    $('.select-pkg').hide();
    $('.select-date').hide();

    //If user has no active subscriptions, only allow to select new package
    if ('{{ entity.profile.is_active }}' == 'True') {
      $('.modal').show();
    } else {
      $('.modal').hide();
      $('.curr-sub').hide();
      $('.select-pkg').show();
      $('.select-date').show();
    }

    // $('#id_package > option').each(function() {
    //   if ($(this).val() == '{{ package }}') {
    //     $(this).attr('selected', 'selected');
    //   }
    // });

    $('.sub-input .start_date').addClass('datepicker');
    $('.sub-input .end_date').addClass('datepicker');
    $('.datepicker').datepicker({
      dateFormat: 'yy-mm-dd',
      minDate: 0,
    });

    $('#id_created_by').val('{{ request.user }}');
    $('#id_bill_day').val('{{ bill_day }}');
    $('#id_username').val('{{ entity.username }}')
    $('.created_by_td').val('{{ request.user }}');
    $('.disabled input').attr('readonly', 'readonly');
    $('.disabled input.end_date').datepicker('destroy');
    $('.disabled input.start_date').datepicker('destroy');

    var today = getToday();
    var yesterday = getYesterday();
    var eopDate = getEop()[0];
    var bdDate = getEop()[1];
    $('.change-eop').text('Start of Next Bill Period:   ' + bdDate);
    $('.end-eop').text('End of this Bill Period:  ' + eopDate);

    if(targetDate != 'None') {
      $('.start_date').val(targetDate);
    }

  //JS for changing package
    $('#change').on('click', function(e) {
      e.preventDefault();
      action = 'change';
      $('.modal').hide();
      $('.select-date').show();
      $('.select-pkg').show();
    })

    $('#id_package').on('change', function() {
      if(!($('#target_date').val())) {
        $('#target_date').val(today);
      }
      $('.change-form').submit();
    })

    //Formset functionality for changing membership package
    $('.sub-formset').formset({
      addText:'Add Another',
      deleteText: 'End'
    })

    $('#end-input').change(function(){
      if ($('#end-input').val() == 'other') {
        $('#sub-end').show();
        $('#sub-end').datepicker('show');
      }
    })

    // Setting up the view if there is a selected package
    if(targetDate != 'None') {
      $('#change-package').show();
      $('.modal').hide();
      $('.sub-form').show();
      $('#new-package').val('{{ package }}');
      $('#id_bill_day').val('{{ bill_day }}');
      $('.curr-sub').hide();
      $('#target_date').val(targetDate);
      $('#id_package > option').each(function() {
        if($(this).val() == '{{ package }}') {
          $(this).attr('selected', 'selected');
        }
      })

      if (action === '') {
        $('#start_date_td input').each(function() {
          if(!($(this).attr('readonly'))) {
            $(this).attr('readonly', 'readonly');
            $(this).datepicker('destroy');
          }
        })
      }
    }

    //End indv. subscription button function/look
    $('.delete-row').addClass('btn-floating btn-large btn');
    $('.delete-row').on('click', function(e) {
      e.preventDefault();
      if(!(end)) {
        end = $('#target_date').val();;
      }
      $(this).parent().siblings('#end_date_td').children().val(end);
      $(this).fadeOut("slow");
    });

    $('#id_package').on('change', function() {
      package = $(this).val();
      $('#id_package > option').each(function() {
        if($(this).val() == package ) {
          $(this).attr('selected', 'selected');
        }
      })
    });

    //Needed???????????
    $('#id_bill_day').on('change', function() {
      $('.change-form').submit();
    })

    // Review all this. What needs to change to match new functionality
    $('.add-row').on('click', function(e) {
			$('.delete-row').addClass('btn-floating btn-large btn');
      $('.username_td').val('{{ entity.username }}');
      $('.created_by_td').val('{{ request.user }}');
      $('.ur_bill_day').val('{{ bill_day }}');
      $('.chosen_package').val('{{ package }}');
      $('.thr_username').val('{{ entity.username }}')

      $('.datepicker').datepicker({
        dateFormat: 'yy-mm-dd',
        minDate: 0
      });

      $('.delete-row').on('click', function(e) {
        e.preventDefault();
        var val = $('#target_date').val();
        $(this).parent().siblings('#end_date_td').children().val(val);
      });
		});

  //Updating subscription functionality
    $('#update').on('click', function(e) {
      e.preventDefault();
      action = 'update';
      $('.modal').hide();

      $('.select-date').show();
      // $('.end-table').css('margin-bottom', '3%');
    })

    if(action == 'update') {
      $('.select-date').on('change', function() {
        $('#change-package').show();
      })
    }

    $('#sub-end').on('change', function() {
      if(action == 'update') {
        $('#target_date').val($('#sub-end').val());
        targetDate = $('#sub-end').val();
        end = targetDate;
        if (action == 'update') {
          dateFiller($('#sub-end').val());
        }
        if (action == 'end') {
          endPackage(period);
        }
      }
    })

    $('#target-input').on('change', function() {
      var period = $('#target-input').val();
      if(period == 'other') {
        $('#sub-end').show();
        $('#sub-end').datepicker('show');
      } else if (period == 'today') {
        targetDate = today;
        end = targetDate;
        $('#target_date').val(today);
        if (action == 'update') {
          dateFiller(today);
        }
        if (action == 'end') {
          endPackage(period);
        }
      } else if (period == 'yesterday') {
        targetDate = yesterday;
        end = targetDate;
        $('#target_date').val(yesterday);
        if (action == 'update') {
          dateFiller(yesterday);
        }
        if (action == 'end') {
          endPackage(period);
        }
      } else if (period == 'eop') {
        targetDate = bdDate;
        end = eopDate;
        $('#target_date').val(bdDate);
        if (action == 'update') {
          dateFiller(bdDate);
        }
        if (action == 'end') {
          $('.subs').before("<input type='hidden' name='date-end' value=" + end + " />");
          endPackage(period);
        }
      }
    })

  //JS for ending membership package
    $('#end').on('click', function(e) {
      e.preventDefault();
      action = 'end';
      $('.select-date').show();
      $('.modal').hide();
    })

    $('.cancel').on('click', function(e) {
      e.preventDefault();
      window.location.replace("{% url 'staff:members:membership' entity.username %}");
    })
  });
</script>
{% endblock %}
