{% extends "staff/settings/base.html" %}

{% block content %}
  <h4>Membership Packages</h4>
  <form action='.' method='POST'>
  <table>
    <tr>
      <td style='width: 12%;'>
        <strong>Package Name:</strong>
      </td>
      <td class='select-td'>
        <select class='select-pkg' name='package'>
          <option selected> ----------- </option>
          <option value='new'>- Create New Package -</option>
          {% for p in packages %}
            <option value='{{ p }}'>
              {{ p.package }}
            </option>
          {% endfor %}
        </select>
      </td>
      <td style='padding-left: 5%;'>
        <input id='enabled' type='checkbox' name='enabled' />
        <label for='enabled'>Enable?</label>
      </td>
    </tr>
  </table>
  <table class='pkg-table'>
    {{ package_formset.management_form }}
    {% for package_form in package_formset %}
      <tr class='package_formset'>
        <td>
          <strong>Resource:</strong>
        </td>
        <td>
          {{ package_form.resource }}
        </td>
        <td>
          <strong>Allowance:</strong>
        </td>
        <td style='width: 10%;'>
          {{ package_form.allowance }}
        </td>
        <td>
          <strong>Monthly Rate:</strong>
        </td>
        <td style='width: 10%;'>
          {{ package_form.monthly_rate }}
        </td>
        <td >
          <strong>Overage Rate:</strong>
        </td>
        <td id='overage-td' style='width: 10%;'>
          {{ package_form.overage_rate}}
        </td>
        <td id='del-td'>
        </td>
      </tr>
    {% endfor %}
  </table>
  <button type='submit'>Create</button>
  {% csrf_token %}
  </form>
  <table>
    <tr>
      <th>Package Name</th>
      <th>Resource</th>
      <th>Allowance</th>
      <th>Monthly Rate</th>
      <th>Overage Rate</th>
      <th></th>
    </tr>
    {% for package in packages %}
      <tr class="{% cycle 'row-even' 'row-odd' %}">
        <td>
          {% ifchanged %}
            {{ package.package }}
          {% endifchanged %}
        </td>
        <td>{{ package.resource }}</td>
        <td>{{ package.allowance }}</td>
        <td>{{ package.monthly_rate }}</td>
        <td style='text-align: center;'>{{ package.overage_rate }}</td>
        <td>
          <button class='edit-package' value='{{ package.id }}'>Edit</button>
        </td>
      </tr>
      <tr class="edit-pkg {% cycle 'row-even' 'row-odd' %}" id='edit-{{ package.id }}'>
        <form action='.' method='POST'>
          <td><input type='hidden' name='edit' /></td>
          <td>
            <input type='hidden' name='pkg_id' value='{{ package.id }}' />
          </td>
          <td>
            {{ package_form.allowance }}
          </td>
          <td>
            {{ package_form.monthly_rate }}
          </td>
          <td>
            {{package_form.overage_rate }}
          </td>
          <td>
            <button type='submit'>Update</button>
          </td>
          <td>
            <a class='cancel'>Cancel</a>
          </td>
          {% csrf_token %}
        </form>
      </tr>
    {% empty %}
      <tr>
        <td colspan="5"><i>No Membership Packages</i></td>
      </tr>
    {% endfor %}
  </table>
{% endblock %}

{% block extrajs %}
<script>
  $(document).ready(function() {
    $('.button-collapse').sideNav();
    $('.collapsible').collapsible();
    $('.edit-pkg').hide();
    $('.package_formset').formset({
      addText:'Add Another',
      deleteText: 'Delete'
    })
    $('.delete-row').appendTo($('#del-td'));

    $('.edit-package').click(function(e) {
      e.preventDefault();
      id = $(this).val();
      $('#edit-' + id).toggle();
    })

    $('.cancel').click(function(e) {
      e.preventDefault();
      $('.edit-pkg').hide();
    })

    $('.select-pkg').on('change', function(){
      if($('.select-pkg').val() == 'new') {
        $('.select-td').empty();
        $('.select-td').append("<input class='pkg-name' type='text' maxlength='128' name='package' placeholder='Enter Package Name Here' />");
      }
    })


    {% for message in messages %}
      {% if message.tags == 'error' %}
        Materialize.toast('{{ message }}', 60000, 'error-msg msg');
      {% else %}
        Materialize.toast('{{ message }}', 3000, '{{ message.tags }}-msg msg');
      {% endif %}
    {% endfor %}

    $(document).on('click', '#toast-container .toast', function() {
      $(this).fadeOut(function(){
        $(this).remove();
      });
    });
  });
</script>
{% endblock %}
